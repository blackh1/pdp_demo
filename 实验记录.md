# äº‘æ•°æ®å®éªŒæŠ¥å‘Š

[toc]

## 1. ç›¸å…³ä¿¡æ¯

### 1.1 è®ºæ–‡é¢˜ç›®

EnclavePDP: A General Framework to Verify Data Integrity in Cloud Using Intel SGX

### 1.2 ç¯å¢ƒå‚æ•°

ç”±äºæœ¬ç»„æˆå‘˜ä½¿ç”¨çš„CPUæœ‰Intelçš„,ä¹Ÿæœ‰AMDçš„,æ‰€ä»¥ä½¿ç”¨SGXçš„æ¨¡æ‹Ÿå·¥å…·æ¥è¿›è¡Œæœ¬æ¬¡å®éªŒ.é™„å½•ä¸­ä¼šä»‹ç»å¦‚ä½•å®‰è£…ç›¸å…³çš„SDK.

- ç¡¬ä»¶ç¯å¢ƒ
  - Intel i7-9750H 4 core
  - å†…å­˜ 4GB
- è½¯ä»¶ç¯å¢ƒ
  - VMware Workstation 16 Pro
  - Ubuntu 20.04 LTS

### 1.3 å®éªŒç›®çš„

1. é˜…è¯»è®ºæ–‡,äº†è§£ç›®å‰PDPæ–¹æ¡ˆçš„å‘å±•çŠ¶å†µä¸å‰æ™¯.
2. äº†è§£ç›¸å…³çš„PDPæ–¹æ¡ˆå’Œç‰¹ç‚¹.
3. å°è¯•æ›´æ”¹ç°æœ‰çš„PDPæ–¹æ¡ˆ.

## 2. èƒŒæ™¯

éšç€äº‘å­˜å‚¨æœåŠ¡çš„æ™®åŠ,è¿œç¨‹éªŒè¯äº‘ä¸Šå¤–åŒ…æ•°æ®çš„å®Œæ•´æ€§å¯¹ç”¨æˆ·æ¥è¯´æ˜¯ä¸€é¡¹æŒ‘æˆ˜.ç°æœ‰çš„å¯è¯æ˜æ•°æ®å æœ‰(PDP)æ–¹æ¡ˆå¤§å¤šæ˜¯æ±‚åŠ©äºç¬¬ä¸‰æ–¹å®¡è®¡å‘˜(TPA)æ¥ä»£è¡¨ç”¨æˆ·éªŒè¯å®Œæ•´æ€§,ä»è€Œå‡å°‘ä»–ä»¬çš„é€šä¿¡å’Œè®¡ç®—è´Ÿæ‹….ç„¶è€Œæ­¤ç±»æ–¹æ¡ˆéœ€è¦å®Œå…¨å¯ä¿¡çš„TPA,è¿™ä¸æ˜¯ä¸€ä¸ªåˆç†çš„å‡è®¾.æ‰€ä»¥æ­¤ç¯‡è®ºæ–‡æå‡ºEnclavePDP,è¿™æ˜¯ä¸€ç§å®‰å…¨çš„é€šç”¨æ•°æ®å®Œæ•´æ€§éªŒè¯æ¡†æ¶,ä¾èµ–Intel SGXä¸ºPDPæ–¹æ¡ˆå»ºç«‹å¯ä¿¡è®¡ç®—åŸºç¡€(TCB),ä»è€Œæ¶ˆé™¤TPA.

## 3. PDPåè®®

### 3.1 å®šä¹‰

æ•°æ®æ‰€æœ‰æƒè¯æ˜(PDP)å…è®¸å®¢æˆ·ç«¯åœ¨ä¸å—ä¿¡ä»»çš„æœåŠ¡å™¨ä¸Šå­˜å‚¨æ•°æ®,å®ƒç”¨æ¥éªŒè¯æœåŠ¡ç«¯æ‹¥æœ‰åŸå§‹æ•°æ®è€Œä¸æ£€ç´¢å®ƒæˆ–è‡ªå·±å­˜å‚¨å‰¯æœ¬.å®ƒé€šè¿‡ä½¿ç”¨ç”Ÿæˆæ¦‚ç‡è¯æ˜åè®®ä¸è¿œç¨‹æœåŠ¡å™¨äº¤äº’æ¥å®ç°ã€‚
ç”±äºæ¥å…¥äº‘çš„è®¾å¤‡å—è®¡ç®—èµ„æºçš„é™åˆ¶,ç”¨æˆ·ä¸å¯èƒ½å°†å¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›èŠ±è´¹åœ¨å¯¹è¿œç¨‹èŠ‚ç‚¹çš„æ•°æ®å®Œæ•´æ€§æ£€æµ‹ä¸Š.é€šå¸¸,äº‘ç”¨æˆ·å°†å®Œæ•´æ€§éªŒè¯ä»»åŠ¡ç§»äº¤ç»™ç»éªŒä¸°å¯Œçš„ç¬¬ä¸‰æ–¹æ¥å®Œæˆ.é‡‡ç”¨ç¬¬ä¸‰æ–¹éªŒè¯æ—¶,éªŒè¯æ–¹åªéœ€è¦æŒæ¡å°‘é‡çš„å…¬å¼€ä¿¡æ¯å³å¯å®Œæˆå®Œæ•´æ€§éªŒè¯ä»»ä»»åŠ¡.

### 3.2 åè®®æµç¨‹

![image](http://other-file.blackh1.top/%E4%BA%91%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E5%AE%9E%E9%AA%8C/5.png)
æ•°æ®å®Œæ•´æ€§è¯æ˜æœºåˆ¶ç”±Setupå’ŒChallengeä¸¤ä¸ªé˜¶æ®µç»„æˆ,é€šè¿‡é‡‡ç”¨æŠ½æ ·çš„ç­–ç•¥å¯¹å­˜å‚¨åœ¨äº‘ä¸­çš„æ•°æ®æ–‡ä»¶å‘èµ·å®Œæ•´æ€§éªŒè¯.å…·ä½“å®ç°ç”±4ä¸ªå¤šé¡¹å¼æ—¶é—´å†…ç®—æ³•ç»„æˆ,å¦‚ä¸‹æ‰€ç¤º:

1. å¯†é’¥ç”Ÿæˆç®—æ³•:$KeyGen(1^ğ‘›)=(pk,sk)$.ç”±ç”¨æˆ·åœ¨æœ¬åœ°æ‰§è¡Œ.$n$ä¸ºå®‰å…¨å‚æ•°,è¿”å›ä¸€ä¸ªåŒ¹é…çš„å…¬é’¥,ç§é’¥å¯¹$(pk,sk)$.

2. æ•°æ®å—æ ‡ç­¾ç”Ÿæˆç®—æ³•:$TagBlock(sk,F)\rightarrow m$.$TagBlock()$ç®—æ³•ç”±ç”¨æˆ·æ‰§è¡Œ,ä¸ºæ¯ä¸ªæ–‡ä»¶ç”ŸæˆåŒæ€ç­¾åæ ‡ç­¾é›†åˆ$m$,ä½œä¸ºè®¤è¯çš„å…ƒæ•°æ®.è¯¥ç®—æ³•è¾“å…¥å‚æ•°åŒ…æ‹¬ç§é’¥$sk$å’Œæ•°æ®æ–‡ä»¶$F$,è¿”å›è®¤è¯çš„å…ƒæ•°æ®$m$.

3. è¯æ®ç”Ÿæˆç®—æ³•:$GenProof(pk,F,m,challenge)\rightarrow P$.è¯¥ç®—æ³•ç”±æœåŠ¡å™¨è¿è¡Œ,ç”Ÿæˆå®Œæ•´æ€§è¯æ®$P$.è¾“å…¥å‚æ•°åŒ…æ‹¬å…¬é’¥$pk$,æ–‡ä»¶$F$,æŒ‘æˆ˜è¯·æ±‚$challenge$å’Œè®¤è¯å…ƒæ•°æ®é›†åˆ$m$.è¿”å›è¯¥æ¬¡è¯·æ±‚çš„å®Œæ•´æ€§è¯æ®$P$.

4. è¯æ®æ£€æµ‹ç®—æ³•:$CheckProof(pk,challenge,P)\rightarrow ("true","false")$.ç”±ç”¨æˆ·æˆ–å¯ä¿¡ç¬¬ä¸‰æ–¹$TPA$è¿è¡Œ,å¯¹æœåŠ¡å™¨è¿”å›çš„è¯æ®$P$è¿›è¡Œåˆ¤æ–­.è¾“å…¥å‚æ•°ä¸ºå…¬é’¥$pk$,æŒ‘æˆ˜è¯·æ±‚$Challenge$åŠ$P$è¿”å›éªŒè¯æˆåŠŸæˆ–å¤±è´¥.

### 3.3 é™åˆ¶

åŒ…å«TPAçš„PDPæ–¹æ¡ˆä¼šæœ‰å¦‚ä¸‹çš„é™åˆ¶,ä¹Ÿå¯ä»¥é€šè¿‡TPAçš„ç±»å‹æ¥è¿›è¡Œåˆ’åˆ†:
![image](http://other-file.blackh1.top/%E4%BA%91%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E5%AE%9E%E9%AA%8C/6.png)

å¯èƒ½çš„å¨èƒ:

- æ¥è‡ªäº‘å­˜å‚¨å¹³å°çš„å†…éƒ¨å’Œå¤–éƒ¨çš„å¨èƒ
- äº‘å­˜å‚¨å¹³å°å‘ç”¨æˆ·éšè—æ•°æ®æŸåäº‹ä»¶
- TPAå¹¶ä¸å¯ä¿¡

## 4. SGXç®€ä»‹

### 4.1 ä»‹ç»

Intel SGXæ˜¯ä¸€é¡¹ä¸ºæ»¡è¶³å¯ä¿¡è®¡ç®—è¡Œä¸šéœ€æ±‚è€Œå¼€å‘çš„æŠ€æœ¯,å…¶ä¿æŠ¤é€‰å®šçš„ä»£ç å’Œæ•°æ®ä¸è¢«æ³„éœ²å’Œä¿®æ”¹.
å®ƒå…è®¸ç”¨æˆ·çº§ä»£ç åˆ›å»ºç§°ä¸ºenclaveçš„ç§æœ‰å†…å­˜åŒºåŸŸ,è¿™äº›åŒºåŸŸä¸ä»¥ç›¸åŒæˆ–æ›´é«˜æƒé™çº§åˆ«è¿è¡Œçš„å…¶ä»–è¿›ç¨‹éš”ç¦».åœ¨enclaveå†…è¿è¡Œçš„ä»£ç ä¸å…¶ä»–åº”ç”¨ç¨‹åº,æ“ä½œç³»ç»Ÿ,ç®¡ç†ç¨‹åºç­‰æœ‰æ•ˆéš”ç¦».

### 4.2 ç»„æˆ

![image](http://other-file.blackh1.top/%E4%BA%91%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E5%AE%9E%E9%AA%8C/7.png)
SGXåº”ç”¨ç”±ä¸¤éƒ¨åˆ†ç»„æˆ:

1. untrustedä¸å¯ä¿¡åŒºä»£ç å’Œæ•°æ®è¿è¡Œåœ¨æ™®é€šéåŠ å¯†å†…å­˜åŒºåŸŸ,ç¨‹åºmainå…¥å£å¿…é¡»åœ¨éå¯ä¿¡åŒº;ä¸Šå›¾ä¸­çš„main()å’Œbar()å‡½æ•°å‡åœ¨éå¯ä¿¡åŒº.
2. truestedå¯ä¿¡åŒºä»£ç å’Œæ•°æ®è¿è¡Œåœ¨ç¡¬ä»¶åŠ å¯†å†…å­˜åŒºåŸŸ,æ­¤åŒºåŸŸç”±CPUåˆ›å»ºçš„ä¸”åªæœ‰CPUæœ‰æƒé™è®¿é—®;
3. ä¸Šå›¾çš„çš„helloworld()å’Œfoo()å‡½æ•°è¿è¡Œåœ¨å¯ä¿¡åŒº.

ä¸‹å›¾ä¸ºç¤ºä¾‹ä»£ç ,å…¶ä¸­è°ƒç”¨æµç¨‹å¦‚å›¾æ‰€ç¤º:
![image](http://other-file.blackh1.top/%E4%BA%91%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E5%AE%9E%E9%AA%8C/3.png)

## 5. ä»£ç æ”¹å†™

æœ¬æ¬¡å®éªŒå‚è€ƒPDPæ–¹æ¡ˆä¸º[Ahmad1234567/provable-data-possession](https://github.com/Ahmad1234567/provable-data-possession.git)

é¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½,Enclaveä¸­æ˜¯ä¸å¯ä»¥é“¾æ¥ç³»ç»Ÿçš„åŠ¨æ€åº“çš„,è€Œä¸”é™æ€åº“è¦ä½¿ç”¨ç¼–è¯‘å¥½çš„,ä¾‹å¦‚SGXSSLç­‰.è€Œæˆ‘ä»¬çš„å‚è€ƒä»£ç ä¸­è¿˜æœ‰åŒ…å«å…¶ä»–å¤´æ–‡ä»¶,å› æ­¤ç›´æ¥æ”¾å…¥Enclaveä¸­æ˜¯ä¸å¯å–çš„,è€Œä¸”ä¹Ÿå°è¯•è¿‡äº†,ç¼–è¯‘ä¸è¿‡,ä¼šå‡ºå¾ˆå¤šé—®é¢˜.å› æ­¤æˆ‘ä»¬éœ€è¦å°†åŸæœ¬çš„PDPæ–¹æ¡ˆä»£ç è¿›è¡Œç®€å•æ›´æ”¹.

- ç”Ÿæˆå¯ä¿¡é™æ€åº“
  é¦–å…ˆå°†pdp-measurements.cå’Œpdp-s3.cå»æ‰åç¼€,æˆ‘ä»¬ç”¨ä¸åˆ°è¿™ä¸ªæ–‡ä»¶.ç„¶åæˆ‘ä»¬å°†å‰©ä¸‹çš„é™¤äº†pdp-app.cæ–‡ä»¶ç¼–è¯‘ç¨‹.oæ–‡ä»¶,æœ€åä½¿ç”¨arè¿›è¡Œç”Ÿæˆé™æ€åº“

  ```bash
  gcc -c *.c
  rm pdp-app.o
  ar crv libpdp.a *.o
  ```

  å³å¯å¾—åˆ°ä¸€ä¸ªå«libpdp.açš„é™æ€åº“æ–‡ä»¶,æˆ‘ä»¬ä¹‹åå°±å¯ä»¥å°†è¯¥æ–‡ä»¶æ”¾åœ¨appå’Œenclaveéƒ¨åˆ†è¿›è¡Œé“¾æ¥,å½“ä½œå¯ä¿¡é™æ€åº“.

- æ”¹å†™app/TestApp.cpp
  æˆ‘ä»¬éœ€è¦è®¾ç½®ç¨‹åºçš„å…¥å£,å¯¹ç›¸å…³å‚æ•°è¿›è¡Œç®€å•çš„åˆ¤æ–­.è€Œä¸”åœ¨å…¶ä¸­æˆ‘ä»¬éœ€è¦åˆ›å»ºenclaveè¿”å›é‡,æ‰€ä»¥éœ€è¦å°†åŸæ¥çš„switchç»“æ„æ›´æ”¹ä¸ºgotoç»“æ„.

- æ”¹å†™enclave/TestEnclave.cpp
  è¿™é‡Œæˆ‘ä»¬æ”¾ecallå‡½æ•°,æ‰€æœ‰éœ€è¦å¯ä¿¡ç¯å¢ƒè¿è¡Œçš„ä»£ç éƒ½è¦æ”¾åœ¨è¿™é‡Œ.åœ¨edlæ–‡ä»¶ä¸­è®¾ç½®publicå±æ€§å¯ä»¥åœ¨TestApp.cppä¸­ç›´æ¥è°ƒç”¨å¯¹åº”å‡½æ•°.

- æ”¹å†™enclave/TestEnclave.edl
  è®¾ç½®å¯ä¿¡å‡½æ•°å’Œä¸å¯ä¿¡å‡½æ•°,éœ€è¦å¯¹æˆ‘ä»¬ä½¿ç”¨çš„å‡½æ•°è¿›è¡Œå¯ä¿¡è¯´æ˜å’Œä¸å¯ä¿¡è¯´æ˜,ä¾‹å¦‚ä¼ å…¥æŒ‡é’ˆåˆ™éœ€è¦è¯´æ˜æŒ‡é’ˆç±»å‹,inè¡¨ç¤ºå¤åˆ¶åˆ°enclaveä¸­,outè¡¨ç¤ºåœ¨enclaveä¸­çš„å˜åŒ–ä¼šå½±å“app,æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªuser_checkå±æ€§,è¿™è¡¨ç¤ºæŒ‡é’ˆå†…å®¹ç”±ç”¨æˆ·è‡ªè¡Œæ£€æŸ¥,åœ¨æ­¤æˆ‘ä»¬ä½¿ç”¨è¯¥å±æ€§å³å¯.

  ```edl
  enclave {
    
    from "sgx_tsgxssl.edl" import *;
    from "sgx_pthread.edl" import *;

    include "../app/pdp.h"
    untrusted {
        void uprint([in, string] const char *str);
        int pdp_tag_file([user_check] char *filepath, size_t filepath_len,[user_check] char *tagfilepath, size_t tagfilepath_len);
        
        PDP_challenge *pdp_challenge_file(unsigned int numfileblocks);
        
        PDP_proof *pdp_prove_file([user_check] char *filepath, size_t filepath_len,[user_check] char *tagfilepath, size_t tagfilepath_len,[user_check] PDP_challenge *challenge,[user_check] PDP_key *key);
      ...
    };

    trusted {
        public void test();
        public void ecall_verify([in,out] char **optarg,long st_size);
    };
  };
  ```

- æ”¹å†™Makefileæ–‡ä»¶
  è¯¥æ–‡ä»¶åŸæœ¬æœ€å¼€å§‹æ˜¯`include ../buildenv.mk`çš„,ä½†æ˜¯æˆ‘ä»¬å¹¶ä¸æƒ³åŒ…å«å¤–éƒ¨æ–‡ä»¶,æ‰€ä»¥å¯ä»¥å°†è¯¥è¡Œæ›¿æ¢ä¸ºå¦‚ä¸‹å†…å®¹:
  
  ```makefile
  SGX_SSL := /opt/intel/sgxssl
  export PACKAGE_LIB := $(SGX_SSL)/lib64/
  export PACKAGE_INC := $(SGX_SSL)/include/
  export SGX_SDK ?= /opt/intel/sgxsdk/
  export VCC := @$(CC)
  export VCXX := @$(CXX)
  export OS_ID=0
  export LINUX_SGX_BUILD ?= 0

  UBUNTU_CONFNAME:=/usr/include/x86_64-linux-gnu/bits/confname.h
  ifneq ("$(wildcard $(UBUNTU_CONFNAME))","")
    OS_ID=1
  else ifeq ($(origin NIX_STORE),environment)
    OS_ID=3
  else
    OS_ID=2
  endif
  ```

- æ”¹å†™sgx_t.mk
  è¿™é‡Œè®¾ç½®çš„æ˜¯enclaveä¸­ä»£ç çš„ç¼–è¯‘é“¾æƒ…å†µ,ä¾‹å¦‚å…ˆé€šè¿‡æŸäº›æ–‡ä»¶ç”Ÿæˆ.cæ–‡ä»¶,ç„¶åç¼–è¯‘æŸäº›æ–‡ä»¶æˆä¸º.oæ–‡ä»¶,æœ€åä½¿ç”¨ç§é’¥è¿›è¡Œç­¾åé˜²æ­¢æ›´æ”¹ç­‰ç­‰æ“ä½œ.

- æ”¹å†™sgx_u.mk
  è¿™é‡Œæ˜¯è®¾ç½®appä¸­ä»£ç çš„ç¼–è¯‘é“¾æƒ…å†µ,åŒsgx_t.mk,åªä¸è¿‡è¿™é‡Œå¤šäº†ä¸€æ­¥é“¾æ¥çš„è¿‡ç¨‹,æ‰€ä»¥è¿™é‡Œéœ€è¦æ›´æ”¹çš„ä¸œè¥¿æ¯”è¾ƒå¤š.ä»¥æ–‡ä»¶ä¸­çš„ä»£ç ä¸ºä¾‹,éœ€è¦æ·»åŠ åŒ…å«çš„åº“è·¯å¾„,è€Œä¸”é“¾æ¥æ—¶ä¹Ÿè¦åŒ…å«åº“çš„å†…å®¹,è¿˜éœ€è¦æ›´æ”¹éƒ¨åˆ†è®¾ç½®.

ä»£ç å·²ç»ä¸Šä¼ åˆ°äº†GitHubä¸Šé¢,ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å³å¯ä¸‹è½½ä»£ç .
```bash
git clone https://github.com/blackh1/pdp_demo.git
```

## 4. ä»£ç ç»“æ„ä»‹ç»

ä»¥å®‰è£…å¥½SGXSSLçš„ç¤ºä¾‹ä»£ç ä¸ºä¾‹,

```bash
.
â”œâ”€â”€ app                         ä¸å¯ä¿¡åŒºåŸŸ
â”‚   â”œâ”€â”€ TestApp.cpp
â”‚   â””â”€â”€ TestApp.h
â”œâ”€â”€ enclave                     å¯ä¿¡åŒºåŸŸ
â”‚   â”œâ”€â”€ TestEnclave.config.xml
â”‚   â”œâ”€â”€ TestEnclave.cpp         å¯ä¿¡å‡½æ•°å®šä¹‰
â”‚   â”œâ”€â”€ TestEnclave.edl         å¯ä¿¡å’Œä¸å¯ä¿¡å‡½æ•°è¯´æ˜
â”‚   â”œâ”€â”€ TestEnclave.h           å¯ä¿¡å‡½æ•°å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ TestEnclave.lds
â”‚   â”œâ”€â”€ TestEnclave_private.pem ç­¾åç§é’¥
â”‚   â””â”€â”€ tests                   è‡ªå®šä¹‰æ–‡ä»¶
â”‚       â”œâ”€â”€ bn_conf.h
â”‚       â”œâ”€â”€ bn_int.h
â”‚       â”œâ”€â”€ bn_lcl.h
â”‚       â”œâ”€â”€ bntest.c
â”‚       â”œâ”€â”€ dhtest.c
â”‚       â”œâ”€â”€ ecdhtest.c
â”‚       â”œâ”€â”€ ecdhtest_cavs.h
â”‚       â”œâ”€â”€ ecdsatest.c
â”‚       â”œâ”€â”€ ectest.c
â”‚       â”œâ”€â”€ e_os.h
â”‚       â”œâ”€â”€ evp_smx.c
â”‚       â”œâ”€â”€ missing_funcs.c
â”‚       â”œâ”€â”€ rsa_test.c
â”‚       â”œâ”€â”€ sha1test.c
â”‚       â”œâ”€â”€ sha256t.c
â”‚       â”œâ”€â”€ stdio_func.c
â”‚       â”œâ”€â”€ threads.h
â”‚       â””â”€â”€ threadstest.c
â”œâ”€â”€ Makefile                    æ•´ä½“makefileæ–‡ä»¶
â”œâ”€â”€ sgx_t.mk                    å¯ä¿¡åŒºåŸŸmakefileæ–‡ä»¶
â””â”€â”€ sgx_u.mk                    ä¸å¯ä¿¡åŒºåŸŸmakefileæ–‡ä»¶
```

é¦–å…ˆæˆ‘ä»¬è¦æ›´æ”¹appä¸­çš„ä»£ç ,å› ä¸ºæ•´ä¸ªç¨‹åºçš„å…¥å£å°±åœ¨appçš„TestAPP.cppä¸­,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†pdp-app.cçš„ä»£ç è¿›è¡Œé€‰æ‹©æ€§çš„å¤åˆ¶.å…¶ä¸­ç”Ÿæˆå¯†é’¥å’Œç”Ÿæˆtagå¯ä»¥æ”¾åœ¨appç¯å¢ƒä¸‹è¿è¡Œ,å› ä¸ºæ­£å¸¸æƒ…å†µä¸‹,è¿™ä¸¤ä¸ªè¿‡ç¨‹æ˜¯åœ¨å®¢æˆ·ç«¯å®Œæˆçš„,æˆ‘ä»¬è¿™é‡Œé›†åˆæˆäº†ä¸€ä¸ªç¨‹åº,æ‰€ä»¥ä¸å†è¿›è¡ŒåŒºåˆ†(å…¶å®çœŸæƒ³åŒºåˆ†ä¹Ÿå¯ä»¥)

å…¶æ¬¡,åœ¨è¯¥è¿è¡Œç¯å¢ƒä¸‹,æˆ‘ä»¬ä¸èƒ½é“¾æ¥åŠ¨æ€åº“,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬çš„å‡½æ•°éƒ¨åˆ†çš„ä»£ç ç¼–è¯‘æˆä¸€ä¸ªé™æ€å¯ä¿¡åº“,è¿™æ ·é“¾æ¥å°±ä¸ä¼šæœ‰é—®é¢˜äº†.

- app/TestApp.cpp TestApp.h
  ç¨‹åºçš„å…¥å£ä»£ç ,ä»¥åŠç›¸å…³å‡½æ•°å®šä¹‰,æˆ–è€…ocallå‡½æ•°å®šä¹‰

- enclave/TestEnclave.cpp TestEnclave.h
  ecallå‡½æ•°çš„å®šä¹‰,ä»¥åŠç›¸å…³å£°æ˜

- enclave/TestEnclave.edl
  å£°æ˜ocallå‡½æ•°å®šä¹‰ä»¥åŠecallå‡½æ•°çš„å®šä¹‰,åŒ…æ‹¬å˜é‡çš„ç±»å‹,æ˜¯å¦ä¼ å…¥ä»¥åŠæ˜¯å¦æœ‰å½±å“,æŒ‡é’ˆå¤„ç†é—®é¢˜

- Makefile
  ç¼–è¯‘è¯¥é¡¹ç›®çš„æ–‡ä»¶,åŒ…å«ç›¸å…³è®¾ç½®ä»¥åŠå¯ä¿¡SSLåº“çš„ä½ç½®,ç”±äºæœ‰äº›è®¾ç½®æ˜¯åŒ…å«åœ¨ä¸Šçº§ç›®å½•ä¸­çš„buildenv.mkä¸­,æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å…¶å¤åˆ¶åˆ°è¯¥æ–‡ä»¶ä¸­.

- sgx_t.mk sgx_u.mk
  åŒ…å«å¯ä¿¡(t)å’Œä¸å¯ä¿¡(u)åŒºåŸŸä»£ç çš„ç¼–è¯‘æƒ…å†µ,ä»¥åŠåŒ…å«æŸäº›æ–‡ä»¶,æˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹å…¶è¿›è¡Œç®€å•æ›´æ”¹.


## é™„å½•

### A. SGXç›¸å…³å®‰è£…

**ç¯å¢ƒè®¾ç½®**

é¦–å…ˆå¯¹äºUbuntu20.04è¿›è¡Œæ¢æº,ä»¥ä¾¿äºä¸‹è½½ç›¸å…³ç¨‹åºå’Œä¾èµ–é¡¹,åœ¨æ­¤ä¸å†ä»‹ç»,ç½‘ä¸Šæœ‰è¯¦ç»†è®²è§£.

- æ›´æ–°

å°†ç¨‹åºè¿›è¡Œæ›´æ–°

```bash
sudo apt update
sudo apt upgrade
```

- é…ç½®ç›¸å…³ç¯å¢ƒ

å®‰è£…ç›¸å…³ä¾èµ–é¡¹

```bash
sudo apt-get update
sudo apt-get install libssl-dev libcurl4-openssl-dev libprotobuf-dev
sudo apt-get install build-enssential python
```

**å®‰è£…SGX Driver**

- æ£€æŸ¥ç›¸å…³éœ€æ±‚(ä»¥ä¸‹æ˜¯Ubuntu)

```bash
dpkg-query -s linux-headers-$(uname -r)
sudo apt-get install linux-headers-$(uname -r)
```

- ä¸‹è½½Intel SGX Driver

ä»¥ä¸‹æ˜¯CSDNç»™å‡ºçš„å®‰è£…æ–¹æ³•

```bash
wget https://download.01.org/intel-sgx/sgx-linux/2.16/distro/ubuntu20.04-server/sgx_linux_x64_driver_2.11.054c9c4c.bin
chmod +x sgx_linux_x64_driver_2.11.054c9c4c.bin
./sgx_linux_x64_driver_2.11.054c9c4c.bin
```

ä»¥ä¸‹æ˜¯Intelå®˜æ–¹ç»™å‡ºçš„å®‰è£…æ–¹æ³•

é¦–å…ˆä½¿ç”¨gitå‘½ä»¤ä¸‹è½½å®˜æ–¹ä»£ç ,ç„¶åä½¿ç”¨makeå‘½ä»¤è‡ªè¡Œbuild.

```bash
git clone https://github.com/intel/linux-sgx-driver.git
cd linux-sgx-driver
make
sudo mkdir -p "/lib/modules/"`uname -r`"/kernel/drivers/intel/sgx"
sudo cp isgx.ko "/lib/modules/"`uname -r`"/kernel/drivers/intel/sgx"
sudo sh -c "cat /etc/modules | grep -Fxq isgx || echo isgx >> /etc/modules"
sudo /sbin/depmod
sudo /sbin/modprobe isgx
```

å®˜æ–¹çš„å¸è½½æ–¹æ³•ä¹Ÿå†™åœ¨è¿™é‡Œ

```bash
sudo /sbin/modprobe -r isgx
sudo rm -rf "/lib/modules/"`uname -r`"/kernel/drivers/intel/sgx"
sudo /sbin/depmod
sudo /bin/sed -i '/^isgx$/d' /etc/modules
```

æœ€åå¯ä»¥ä½¿ç”¨`lsmod|grep isgx`æ¥æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ.

**å®‰è£…SGX SDK**

é¦–å…ˆå®‰è£…ç›¸å…³çš„ä¾èµ–å·¥å…·

```bash
sudo apt-get install build-essential ocaml ocamlbuild automake autoconf libtool wget python-is-python3 libssl-dev git cmake perl
```

å¦‚æœè¿™æ­¥å‡ºç°ä¾èµ–é—®é¢˜,å¯ä»¥ä½¿ç”¨aptitudeæ¥è§£å†³.

```bash
sudo apt-get install aptitude
sudo aptitude install build-essential ocaml ocamlbuild automake autoconf libtool wget python-is-python3 libssl-dev git cmake perl
```

åœ¨è§£å†³æ–¹æ¡ˆä¸­å…ˆé€‰æ‹©n,ç„¶åé€‰æ‹©Yå³å¯.[å¯è§è¿™ç¯‡æ–‡ç« ](https://www.jianshu.com/p/ce514e8738e1)

**å®‰è£…SGX PSW(ç¡¬ä»¶ä¸æ”¯æŒå¯ä»¥ä¸è£…)**

```bash
sudo apt-get install libssl-dev libcurl4-openssl-dev protobuf-compiler libprotobuf-dev debhelper cmake reprepro unzip
```

ä¸‹è½½ç›¸å…³èµ„æº

```bash
git clone https://github.com/intel/linux-sgx.git
cd linux-sgx && make preparation
```

è¿è¡Œè¯¥å‘½ä»¤åä¼šè¿›è¡Œä¸€ç³»åˆ—çš„ä¸‹è½½æ“ä½œï¼Œåªéœ€è¦è€å¿ƒç­‰å€™,æœ€ç»ˆä¼šå‡ºç°ä»¥ä¸‹å­—æ ·,å³å¯ä»£è¡¨å®Œæˆ

![image](http://other-file.blackh1.top/%E4%BA%91%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E5%AE%9E%E9%AA%8C/4.png)

ç„¶åæˆ‘ä»¬å°†å¯¹åº”çš„å·¥å…·å¤åˆ¶åˆ°å¯¹åº”ä½ç½®ä»¥ä¾¿äºä¹‹åçš„ä½¿ç”¨.

```bash
sudo cp external/toolset/ubuntu20.04/* /usr/local/bin
which ar as ld objcopy objdump ranlib
```

**Build SGXå®‰è£…ç¨‹åº**

```bash
make sdk
make sdk_install_pkg
```

è¿è¡Œå®Œä»¥ä¸Šå‘½ä»¤å,å°±å¯ä»¥åœ¨`linux/installer/bin/`ä¸‹é¢äº†,ç„¶åè¿è¡Œ`./sgx_linux_x64_sdk_2.16.100.4.bin`å°±å¯ä»¥å®‰è£…äº†

ç¬¬äºŒç§æ–¹å¼:

```bash
wget https://download.01.org/intel-sgx/sgx-linux/2.16/distro/ubuntu20.04-server/sgx_linux_x64_sdk_2.16.100.4.bin
chmod +x sgx_linux_x64_sdk_2.16.100.4.bin
./sgx_linux_x64_sdk_2.16.100.4.bin
```

å¦‚æœå‡ºç°æƒé™ä¸è¶³å°±ä½¿ç”¨sudoå®‰è£…,æˆ–è€…æ›´æ”¹/optæ–‡ä»¶å¤¹çš„æƒé™.ä¸€å®šè¦å®‰è£…åœ¨/opt/intelä¸‹,å› ä¸ºåé¢çš„SGXSSLé»˜è®¤é…ç½®makefileé‡Œé¢éƒ½æ˜¯è¿™ä¸ªç›®å½•.å¦‚æœæ›´æ¢å®‰è£…ä½ç½®,éœ€è¦æ›´æ”¹makefileæ–‡ä»¶å†…å®¹,æ¯”è¾ƒéº»çƒ¦.

**å®‰è£…SGX SSL**

é¦–å…ˆä¸‹è½½ç›¸å…³æºç .

```bash
wget https://github.com/intel/intel-sgx-ssl/archive/refs/tags/lin_2.16_1.1.1m_update.zip
unzip lin_2.16_1.1.1m_update.zip
cd intel-sgx-ssl-lin_2.16_1.1.1m_update/openssl_source
wget https://github.com/openssl/openssl/archive/refs/tags/OpenSSL_1_1_1m.tar.gz
tar -zxvf OpenSSL_1_1_1m.tar.gz
mv openssl-OpenSSL_1_1_1m openssl-1.1.1m
tar -zcf openssl-1.1.1m.tar.gz openssl-1.1.1m
cd ../Linux
make all test SGX_MODE=SIM
sudo make install
```

åœ¨testè¿è¡Œä¹‹åä¼šæœ‰ç»“æœ,æ˜¾ç¤ºä¸€å †OKè€Œä¸”æœ‰å„ç§æµ‹è¯•è¯´æ˜æˆåŠŸ.SGXSSLä¹Ÿä¼šå®‰è£…åœ¨`/opt/intel`ä¸‹é¢

